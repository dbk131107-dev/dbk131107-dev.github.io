<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lịch Làm Việc & Tính Lương (Cập nhật CN)</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen py-6 px-4">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- ICONS ---
        const Icon = ({ path, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{path}</svg>
        );
        const CalendarIcon = (p) => <Icon {...p} path={<><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></>} />;
        const DownloadIcon = (p) => <Icon {...p} path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></>} />;
        const ChevronLeftIcon = (p) => <Icon {...p} path={<polyline points="15 18 9 12 15 6"></polyline>} />;
        const ChevronRightIcon = (p) => <Icon {...p} path={<polyline points="9 18 15 12 9 6"></polyline>} />;
        const BuildingIcon = (p) => <Icon {...p} path={<><rect x="4" y="2" width="16" height="20" rx="2" ry="2"></rect><line x1="9" y1="22" x2="9" y2="22"></line><line x1="15" y1="22" x2="15" y2="22"></line><line x1="12" y1="11" x2="12" y2="17"></line><line x1="12" y1="7" x2="12.01" y2="7"></line></>} />;
        const WifiIcon = (p) => <Icon {...p} path={<><path d="M5 12.55a11 11 0 0 1 14.08 0"></path><path d="M1.42 9a16 16 0 0 1 21.16 0"></path><path d="M8.53 16.11a6 6 0 0 1 6.95 0"></path><line x1="12" y1="20" x2="12.01" y2="20"></line></>} />;

        function App() {
            // Load dữ liệu từ LocalStorage
            const savedAttendance = JSON.parse(localStorage.getItem('myAttendanceData_v3')) || {};
            // Lưu riêng 2 loại lương
            const savedRates = JSON.parse(localStorage.getItem('myRates_v3')) || { center: 55000, online: 50000 };

            const [currentDate, setCurrentDate] = useState(new Date());
            const [attendance, setAttendance] = useState(savedAttendance);
            const [rates, setRates] = useState(savedRates);

            useEffect(() => {
                localStorage.setItem('myAttendanceData_v3', JSON.stringify(attendance));
                localStorage.setItem('myRates_v3', JSON.stringify(rates));
            }, [attendance, rates]);

            // --- CẤU HÌNH LỊCH MỚI ---
            const SCHEDULE_RULES = {
                6: [ // Thứ 7
                    { name: 'Ca Sáng (Trung tâm)', time: '08:30 - 11:30', hours: 3, id: 'sat_m', rateType: 'center', icon: 'building' },
                    { name: 'Ca Tối (Online)', time: '19:30 - 21:00', hours: 1.5, id: 'sat_e', rateType: 'online', icon: 'wifi' }
                ],
                0: [ // Chủ Nhật (Đã cập nhật giờ)
                    { name: 'Ca Sáng (Online)', time: '08:00 - 09:30', hours: 1.5, id: 'sun_m', rateType: 'online', icon: 'wifi' }
                ]
            };

            const [shifts, setShifts] = useState([]);

            useEffect(() => {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const date = new Date(year, month, 1);
                const newShifts = [];

                while (date.getMonth() === month) {
                    const dayOfWeek = date.getDay();
                    if (SCHEDULE_RULES[dayOfWeek]) {
                        SCHEDULE_RULES[dayOfWeek].forEach(rule => {
                            newShifts.push({
                                date: new Date(date),
                                dateString: date.toLocaleDateString('vi-VN'),
                                dayName: dayOfWeek === 0 ? 'Chủ Nhật' : 'Thứ 7',
                                ...rule
                            });
                        });
                    }
                    date.setDate(date.getDate() + 1);
                }
                setShifts(newShifts);
            }, [currentDate]);

            const toggleStatus = (dateStr, shiftId) => {
                const key = `${dateStr}-${shiftId}`;
                const current = attendance[key] || 'PENDING';
                let next = current === 'PENDING' ? 'DONE' : (current === 'DONE' ? 'OFF' : 'PENDING');
                setAttendance(prev => ({ ...prev, [key]: next }));
            };

            // Tính toán chi tiết
            const stats = shifts.reduce((acc, shift) => {
                const key = `${shift.dateString}-${shift.id}`;
                const status = attendance[key] || 'PENDING';

                if (status === 'DONE') {
                    acc.days += 1;
                    acc.hours += shift.hours;
                    const currentRate = rates[shift.rateType];
                    acc.salary += shift.hours * currentRate;
                }
                return acc;
            }, { hours: 0, days: 0, salary: 0 });

            const formatMoney = (amount) => {
                return amount.toLocaleString('vi-VN') + ' đ';
            };

            const changeMonth = (offset) => {
                const newDate = new Date(currentDate.setMonth(currentDate.getMonth() + offset));
                setCurrentDate(new Date(newDate));
            };

            const exportToCSV = () => {
                const monthStr = `Tháng ${currentDate.getMonth() + 1}-${currentDate.getFullYear()}`;
                let csvContent = `sep=,\nBẢNG CHẤM CÔNG CÁ NHÂN - ${monthStr}\n`;
                csvContent += `Ngày,Thứ,Ca làm việc,Loại,Thời gian,Số giờ,Mức lương/h,Thành tiền,Trạng thái\n`;

                shifts.forEach(shift => {
                    const key = `${shift.dateString}-${shift.id}`;
                    const status = attendance[key] || 'PENDING';
                    let statusText = 'Chưa làm';
                    let money = 0;
                    
                    if (status === 'DONE') {
                        statusText = 'Đã làm';
                        money = shift.hours * rates[shift.rateType];
                    } else if (status === 'OFF') {
                        statusText = 'Nghỉ';
                    }

                    const rateDisplay = rates[shift.rateType];
                    csvContent += `"${shift.dateString}","${shift.dayName}","${shift.name}","${shift.rateType === 'center' ? 'Trung tâm' : 'Online'}","${shift.time}",${shift.hours},${rateDisplay},${money},"${statusText}"\n`;
                });

                csvContent += `\nTổng cộng:,,,,,,TỔNG THU NHẬP:,${stats.salary}\n`;
                
                const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.setAttribute("href", url);
                link.setAttribute("download", `Luong_Thang_${currentDate.getMonth() + 1}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            return (
                <div className="max-w-2xl mx-auto bg-white shadow-xl rounded-xl overflow-hidden border border-gray-200">
                    {/* Header */}
                    <div className="bg-blue-600 p-6 text-white">
                        <div className="flex justify-between items-center mb-6">
                            <h1 className="text-xl font-bold flex items-center gap-2">
                                <CalendarIcon className="w-6 h-6" /> Quản Lý Lương
                            </h1>
                            <div className="flex items-center gap-4 bg-blue-700/50 rounded-lg p-1">
                                <button onClick={() => changeMonth(-1)} className="p-1 hover:bg-blue-600 rounded"><ChevronLeftIcon className="w-5 h-5"/></button>
                                <span className="font-bold min-w-[100px] text-center">Tháng {currentDate.getMonth() + 1}/{currentDate.getFullYear()}</span>
                                <button onClick={() => changeMonth(1)} className="p-1 hover:bg-blue-600 rounded"><ChevronRightIcon className="w-5 h-5"/></button>
                            </div>
                        </div>
                        
                        {/* Summary Cards */}
                        <div className="grid grid-cols-2 gap-4">
                            <div className="bg-white/10 backdrop-blur-sm p-4 rounded-lg border border-white/20">
                                <div className="text-blue-100 text-xs uppercase font-bold mb-1">Tổng giờ làm</div>
                                <div className="text-2xl font-bold">{stats.hours}h <span className="text-sm font-normal opacity-70">/ {stats.days} ca</span></div>
                            </div>
                            <div className="bg-white text-blue-700 p-4 rounded-lg shadow-lg">
                                <div className="text-blue-500 text-xs uppercase font-bold mb-1">Tổng Lương Dự Kiến</div>
                                <div className="text-2xl font-bold">{formatMoney(stats.salary)}</div>
                            </div>
                        </div>
                    </div>

                    {/* Settings Rate */}
                    <div className="grid grid-cols-2 gap-px bg-gray-200 border-b border-gray-200">
                        <div className="bg-white p-3 flex flex-col items-center">
                            <label className="text-xs font-bold text-gray-400 mb-1 flex items-center gap-1"><BuildingIcon className="w-3 h-3"/> Lương Trung tâm (đ/h)</label>
                            <input type="number" value={rates.center} onChange={(e) => setRates({...rates, center: Number(e.target.value)})} 
                                className="text-center font-bold text-gray-700 w-full outline-none focus:text-blue-600 border-b border-transparent focus:border-blue-300" />
                        </div>
                        <div className="bg-white p-3 flex flex-col items-center">
                            <label className="text-xs font-bold text-gray-400 mb-1 flex items-center gap-1"><WifiIcon className="w-3 h-3"/> Lương Online (đ/h)</label>
                            <input type="number" value={rates.online} onChange={(e) => setRates({...rates, online: Number(e.target.value)})} 
                                className="text-center font-bold text-gray-700 w-full outline-none focus:text-blue-600 border-b border-transparent focus:border-blue-300" />
                        </div>
                    </div>

                    {/* Schedule List */}
                    <div className="overflow-x-auto">
                        <table className="w-full text-sm">
                            <thead className="bg-gray-50 text-gray-500 text-xs uppercase border-b">
                                <tr>
                                    <th className="p-3 text-left">Ngày</th>
                                    <th className="p-3 text-left">Ca làm</th>
                                    <th className="p-3 text-center">Lương/Ca</th>
                                    <th className="p-3 text-center">Trạng thái</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-100">
                                {shifts.map((shift, index) => {
                                    const key = `${shift.dateString}-${shift.id}`;
                                    const status = attendance[key] || 'PENDING';
                                    const rate = rates[shift.rateType];
                                    const salaryPerShift = shift.hours * rate;
                                    
                                    let rowClass = "hover:bg-gray-50";
                                    let btnClass = "bg-gray-100 text-gray-500 hover:bg-gray-200";
                                    let btnText = "Chưa làm";

                                    if (status === 'DONE') {
                                        rowClass = "bg-blue-50/40";
                                        btnClass = "bg-green-100 text-green-700 border border-green-200 shadow-sm";
                                        btnText = "Đã làm";
                                    } else if (status === 'OFF') {
                                        rowClass = "opacity-50 bg-gray-50";
                                        btnClass = "bg-red-50 text-red-500 border border-red-100";
                                        btnText = "Nghỉ";
                                    }

                                    return (
                                        <tr key={index} className={`transition-colors ${rowClass}`}>
                                            <td className="p-3">
                                                <div className={`font-bold ${shift.dayName === 'Chủ Nhật' ? 'text-red-500' : 'text-gray-700'}`}>{shift.dayName}</div>
                                                <div className="text-xs text-gray-400">{shift.dateString}</div>
                                            </td>
                                            <td className="p-3">
                                                <div className="font-medium text-gray-800 flex items-center gap-1.5">
                                                    {shift.rateType === 'center' ? <BuildingIcon className="w-3 h-3 text-indigo-500"/> : <WifiIcon className="w-3 h-3 text-teal-500"/>}
                                                    {shift.name}
                                                </div>
                                                <div className="text-xs text-gray-500 mt-0.5">{shift.time} ({shift.hours}h)</div>
                                            </td>
                                            <td className="p-3 text-center">
                                                <div className="font-mono text-gray-600 font-bold">{formatMoney(salaryPerShift)}</div>
                                                <div className="text-[10px] text-gray-400">({formatMoney(rate)}/h)</div>
                                            </td>
                                            <td className="p-3 text-center">
                                                <button onClick={() => toggleStatus(shift.dateString, shift.id)} 
                                                    className={`px-3 py-1.5 rounded-md text-xs font-bold w-full transition-all ${btnClass}`}>
                                                    {btnText}
                                                </button>
                                            </td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>

                    <div className="p-4 border-t border-gray-200 bg-gray-50 flex justify-center">
                        <button onClick={exportToCSV} className="flex items-center gap-2 text-blue-600 font-bold hover:text-blue-800 transition-colors">
                            <DownloadIcon className="w-4 h-4" /> Tải báo cáo Excel
                        </button>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
