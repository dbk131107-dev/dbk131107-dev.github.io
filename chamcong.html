<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lịch Đi Làm Cá Nhân</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel để đọc JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- ICONS (Tự tạo icon SVG để không phụ thuộc thư viện ngoài) ---
        const Icon = ({ path, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {path}
            </svg>
        );

        const CalendarIcon = (props) => <Icon {...props} path={<><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></>} />;
        const DownloadIcon = (props) => <Icon {...props} path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></>} />;
        const CheckCircleIcon = (props) => <Icon {...props} path={<><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></>} />;
        const XCircleIcon = (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></>} />;
        const ClockIcon = (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></>} />;
        const ChevronLeftIcon = (props) => <Icon {...props} path={<polyline points="15 18 9 12 15 6"></polyline>} />;
        const ChevronRightIcon = (props) => <Icon {...props} path={<polyline points="9 18 15 12 9 6"></polyline>} />;

        // --- APP CHÍNH ---
        function App() {
            // Lấy dữ liệu từ LocalStorage để không bị mất khi tải lại trang
            const savedAttendance = JSON.parse(localStorage.getItem('myAttendanceData')) || {};
            const savedRate = JSON.parse(localStorage.getItem('myHourlyRate')) || 50000;

            const [currentDate, setCurrentDate] = useState(new Date());
            const [attendance, setAttendance] = useState(savedAttendance);
            const [hourlyRate, setHourlyRate] = useState(savedRate);

            // Lưu dữ liệu mỗi khi thay đổi
            useEffect(() => {
                localStorage.setItem('myAttendanceData', JSON.stringify(attendance));
                localStorage.setItem('myHourlyRate', JSON.stringify(hourlyRate));
            }, [attendance, hourlyRate]);

            const SCHEDULE_RULES = {
                6: [
                    { name: 'Ca Sáng', time: '08:30 - 11:30', hours: 3, id: 'sat_m' },
                    { name: 'Ca Tối', time: '19:30 - 21:00', hours: 1.5, id: 'sat_e' }
                ],
                0: [
                    { name: 'Ca Sáng', time: '08:30 - 11:30', hours: 3, id: 'sun_m' }
                ]
            };

            const [shifts, setShifts] = useState([]);

            useEffect(() => {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const date = new Date(year, month, 1);
                const newShifts = [];

                while (date.getMonth() === month) {
                    const dayOfWeek = date.getDay();
                    
                    if (SCHEDULE_RULES[dayOfWeek]) {
                        SCHEDULE_RULES[dayOfWeek].forEach(rule => {
                            newShifts.push({
                                date: new Date(date),
                                dateString: date.toLocaleDateString('vi-VN'),
                                dayName: dayOfWeek === 0 ? 'Chủ Nhật' : 'Thứ 7',
                                ...rule
                            });
                        });
                    }
                    date.setDate(date.getDate() + 1);
                }
                setShifts(newShifts);
            }, [currentDate]);

            const toggleStatus = (dateStr, shiftId) => {
                const key = `${dateStr}-${shiftId}`;
                const current = attendance[key] || 'PENDING';
                
                let next = 'PENDING';
                if (current === 'PENDING') next = 'DONE';
                else if (current === 'DONE') next = 'OFF';
                else next = 'PENDING';

                setAttendance(prev => ({ ...prev, [key]: next }));
            };

            const stats = shifts.reduce((acc, shift) => {
                const key = `${shift.dateString}-${shift.id}`;
                const status = attendance[key] || 'PENDING';

                if (status === 'DONE') {
                    acc.hours += shift.hours;
                    acc.days += 1;
                }
                return acc;
            }, { hours: 0, days: 0 });

            const exportToCSV = () => {
                const monthStr = `Tháng ${currentDate.getMonth() + 1}-${currentDate.getFullYear()}`;
                let csvContent = `sep=,\nBẢNG CHẤM CÔNG CÁ NHÂN - ${monthStr}\n`;
                csvContent += `Ngày,Thứ,Ca làm việc,Thời gian,Số giờ,Trạng thái\n`;

                shifts.forEach(shift => {
                    const key = `${shift.dateString}-${shift.id}`;
                    const status = attendance[key] || 'PENDING';
                    let statusText = 'Chưa chấm';
                    if (status === 'DONE') statusText = 'Đã làm';
                    if (status === 'OFF') statusText = 'Nghỉ';

                    csvContent += `"${shift.dateString}","${shift.dayName}","${shift.name}","${shift.time}","${shift.hours}","${statusText}"\n`;
                });

                csvContent += `\nTổng kết:,,,Tổng giờ làm:,${stats.hours},Tổng lương: ${stats.hours * hourlyRate}\n`;

                const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.setAttribute("href", url);
                link.setAttribute("download", `Lich_Lam_Viec_${currentDate.getMonth() + 1}_${currentDate.getFullYear()}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const changeMonth = (offset) => {
                const newDate = new Date(currentDate.setMonth(currentDate.getMonth() + offset));
                setCurrentDate(new Date(newDate));
            };

            return (
                <div className="p-4 font-sans text-sm max-w-3xl mx-auto">
                    <div className="bg-white shadow-xl rounded-xl overflow-hidden border border-gray-200">
                        {/* Header */}
                        <div className="bg-gradient-to-r from-blue-600 to-blue-500 p-6 text-white">
                            <div className="flex justify-between items-start mb-4">
                                <div>
                                    <h1 className="text-2xl font-bold flex items-center gap-2">
                                        <CalendarIcon className="w-6 h-6" /> Lịch Đi Làm Cá Nhân
                                    </h1>
                                    <p className="opacity-90 mt-1 text-sm">Chỉ Thứ 7 & Chủ Nhật</p>
                                </div>
                                <button 
                                    onClick={exportToCSV}
                                    className="bg-white text-blue-600 px-4 py-2 rounded-lg font-bold shadow-lg hover:bg-gray-100 transition-colors flex items-center gap-2 text-sm"
                                >
                                    <DownloadIcon className="w-4 h-4" /> Xuất Excel
                                </button>
                            </div>

                            <div className="flex items-center justify-between bg-white/10 rounded-lg p-3 backdrop-blur-sm">
                                <button onClick={() => changeMonth(-1)} className="p-1 hover:bg-white/20 rounded"><ChevronLeftIcon className="w-6 h-6"/></button>
                                <span className="font-bold text-lg">Tháng {currentDate.getMonth() + 1} / {currentDate.getFullYear()}</span>
                                <button onClick={() => changeMonth(1)} className="p-1 hover:bg-white/20 rounded"><ChevronRightIcon className="w-6 h-6"/></button>
                            </div>
                        </div>

                        {/* Dashboard Stats */}
                        <div className="grid grid-cols-3 gap-4 p-4 border-b border-gray-100">
                            <div className="bg-green-50 p-3 rounded-lg border border-green-100 text-center">
                                <div className="text-gray-500 text-xs uppercase font-bold">Số ca đã làm</div>
                                <div className="text-xl font-bold text-green-600">{stats.days} <span className="text-sm font-normal">ca</span></div>
                            </div>
                            <div className="bg-blue-50 p-3 rounded-lg border border-blue-100 text-center">
                                <div className="text-gray-500 text-xs uppercase font-bold">Tổng giờ</div>
                                <div className="text-xl font-bold text-blue-600">{stats.hours}h</div>
                            </div>
                            <div className="bg-orange-50 p-3 rounded-lg border border-orange-100 text-center flex flex-col justify-center">
                                <div className="text-gray-500 text-xs uppercase font-bold mb-1">Lương (tạm tính)</div>
                                <div className="flex items-center justify-center gap-1">
                                    <input 
                                        type="number" 
                                        value={hourlyRate}
                                        onChange={(e) => setHourlyRate(Number(e.target.value))}
                                        className="w-20 text-center bg-white border border-orange-200 rounded px-1 text-sm text-orange-600 font-bold focus:outline-none"
                                    />
                                    <span className="text-xs text-gray-400">đ/giờ</span>
                                </div>
                                <div className="text-sm font-bold text-orange-600 mt-1">
                                    {(stats.hours * hourlyRate).toLocaleString('vi-VN')} đ
                                </div>
                            </div>
                        </div>

                        {/* List of Shifts */}
                        <div className="overflow-x-auto">
                            <table className="w-full">
                                <thead className="bg-gray-100 text-gray-500 text-xs uppercase">
                                    <tr>
                                        <th className="p-4 text-left">Ngày</th>
                                        <th className="p-4 text-left">Ca làm việc</th>
                                        <th className="p-4 text-center">Thời gian</th>
                                        <th className="p-4 text-center">Trạng thái</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-100">
                                    {shifts.map((shift, index) => {
                                        const key = `${shift.dateString}-${shift.id}`;
                                        const status = attendance[key] || 'PENDING';
                                        
                                        let rowClass = "hover:bg-gray-50 transition-colors";
                                        let statusBtnClass = "bg-gray-100 text-gray-500 hover:bg-gray-200";
                                        let statusIcon = <ClockIcon className="w-4 h-4" />;
                                        let statusText = "Chưa làm";

                                        if (status === 'DONE') {
                                            rowClass = "bg-green-50/50 hover:bg-green-50";
                                            statusBtnClass = "bg-green-100 text-green-700 border border-green-200";
                                            statusIcon = <CheckCircleIcon className="w-4 h-4" />;
                                            statusText = "Đã làm";
                                        } else if (status === 'OFF') {
                                            rowClass = "bg-red-50/30 hover:bg-red-50";
                                            statusBtnClass = "bg-red-100 text-red-600 border border-red-200";
                                            statusIcon = <XCircleIcon className="w-4 h-4" />;
                                            statusText = "Nghỉ";
                                        }

                                        return (
                                            <tr key={index} className={rowClass}>
                                                <td className="p-4 whitespace-nowrap">
                                                    <div className={`font-bold text-gray-800 ${shift.dayName === 'Chủ Nhật' ? 'text-red-600' : ''}`}>
                                                        {shift.dayName}
                                                    </div>
                                                    <div className="text-xs text-gray-500">{shift.dateString}</div>
                                                </td>
                                                <td className="p-4">
                                                    <div className="font-medium text-gray-900">{shift.name}</div>
                                                    <div className="text-xs text-gray-500 hidden sm:block">Chấm công để tính lương</div>
                                                </td>
                                                <td className="p-4 text-center">
                                                    <div className="inline-flex flex-col items-center">
                                                        <span className="font-mono font-bold text-gray-700 bg-gray-100 px-2 py-1 rounded text-xs">{shift.time}</span>
                                                        <span className="text-[10px] text-gray-400 mt-1">{shift.hours} tiếng</span>
                                                    </div>
                                                </td>
                                                <td className="p-4 text-center">
                                                    <button 
                                                        onClick={() => toggleStatus(shift.dateString, shift.id)}
                                                        className={`flex items-center justify-center gap-2 px-3 py-2 rounded-lg font-medium text-xs w-full sm:w-auto min-w-[100px] transition-all ${statusBtnClass}`}
                                                    >
                                                        {statusIcon}
                                                        {statusText}
                                                    </button>
                                                </td>
                                            </tr>
                                        );
                                    })}
                                    {shifts.length === 0 && (
                                        <tr><td colSpan="4" className="p-8 text-center text-gray-400">Không có lịch làm việc tháng này.</td></tr>
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>